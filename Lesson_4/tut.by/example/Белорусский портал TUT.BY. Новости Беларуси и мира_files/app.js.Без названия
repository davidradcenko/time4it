var TUTBYPushManager=TUTBYPushManager||function(){function e(e,t){this.name=e,this.version=parseInt(t||1,10),this.table="app_store"}function t(){}function n(){}function o(e,t){return e?t?e.endpoint.replace(/^.*\/([^\/]+)$/,"$1"):e.endpoint:null}function i(e){var t=e.match(/^#check-(.+)$/);if(!t)return!1;try{return JSON.parse(l(t[1]))}catch(e){}return!1}function r(e){if(e)return e[0];var t;return(t=navigator.userAgent.match(/Firefox\/(\d+)\.\d+/))?parseInt(t[1],10)>43&&"serviceWorker"in navigator&&"firefox":(t=navigator.userAgent.match(/Version\/(\d+).* Safari/))&&!navigator.userAgent.match(/iP(?:hone|[ao]d)/)?parseInt(t[1],10)>7&&"safari"in window&&"pushNotification"in window.safari&&"safari":navigator.userAgent.match(/Chrome\/\d+\./i)&&(t=navigator.userAgent.match(/ OPR\/(\d+)\./))?parseInt(t[1],10)>=42&&"serviceWorker"in navigator&&"chrome":!(!(t=navigator.userAgent.match(/Chrome\/(\d+)\./i))||navigator.userAgent.match(/(?:Edge|OPR\/| wv|iP(?:hone|[ao]d))/))&&(parseInt(t[1],10)>41&&"serviceWorker"in navigator&&"chrome")}function a(){function e(e){e=e||window.safari.pushNotification.permission(p.apn_id);var o=new n,i=e.deviceToken,r=e.permission;o.manageToken(r,i).then(function(){p.log(r),t(r,i);try{window.yaCounter46086984.reachGoal("push_settings",function(){var e={};return e["push_"+p.platform]={permission:r},e}())}catch(e){console.log(e)}}).catch(function(e){p.log("[AS] error",e)})}function t(e,t){switch(e){case"granted":$("#grantedSubscribe").prop("checked",!!t).prop("disabled",!0),$("html").attr("class","granted");break;case"default":p.autoRegister&&$("html.default").length<1?($("html").attr("class","default"),$("html.default #defaultSubscribe").trigger("click")):($("html").attr("class","default"),$("html.default #defaultSubscribe").show());break;case"denied":$("html").attr("class","denied")}}function o(){$("body").addClass("safari"),p.return_url&&-1===p.return_url.indexOf("https://www.tut.by/push/")&&($("form").each(function(){var e=$(this);e.attr("action",p.defaultUrl+p.scope+"redir"),$('<input type="hidden" name="url" value="'+p.return_url.replace(/"/g,"&quote;")+'" />').appendTo(e)}),$('input[type="submit"]').val("Вернуться")),$(document).on("click","html.default #defaultSubscribe",function(t){return window.safari.pushNotification.requestPermission(p.defaultUrl+p.scope.replace(/\/*$/g,""),p.apn_id,null,e),t.preventDefault(),!1}),p.autoRegister&&$("html.default #defaultSubscribe").trigger("click")}o(),e()}function s(){function e(){var e=document.createElement("link");e.rel="manifest",e.href=p.defaultUrl+p.scope+"manifest.json",document.head.appendChild(e)}function t(e){e.pushManager.getSubscription(p.scope).then(function(e){var t=new n,r=o(e,"chrome"==p.platform),a=Notification.permission;t.manageToken(a,r).then(function(){i(a,r);try{window.yaCounter46086984.reachGoal("push_settings",function(){var e={};return e["push_"+p.platform]={permission:a},e}())}catch(e){console.log(e)}}).catch(function(e){p.log("[AS] error",e)})}).catch(function(e){p.log("[SW] Error getting subscription",e)})}function i(e,t){switch(e){case"granted":$("#grantedSubscribe").prop("checked",!!t),$("html").attr("class","granted");break;case"default":p.autoRegister&&$("html.default").length<1?($("html").attr("class","default"),$("html.default #defaultSubscribe").trigger("click")):($("html").attr("class","default"),$('html.default #defaultSubscribe,html.default div.default input[type="submit"]').show());break;case"denied":$("html").attr("class","denied")}}function r(e){$("body").addClass(p.platform),p.return_url&&-1===p.return_url.indexOf("https://www.tut.by/push/")&&($("form").each(function(){var e=$(this);e.attr("action",p.defaultUrl+p.scope+"redir"),$('<input type="hidden" name="url" value="'+p.return_url.replace(/"/g,"&quote;")+'" />').appendTo(e)}),$('input[type="submit"]').val("Вернуться")),$(document).on("click","html.default #defaultSubscribe",function(n){e.pushManager.subscribe({userVisibleOnly:!0}).then(function(){t(e)}).catch(function(n){t(e)}),n.preventDefault()}),$(document).on("click","html.granted #grantedSubscribe",function(n){$("html.granted #grantedSubscribe").prop("checked")?e.pushManager.subscribe({userVisibleOnly:!0}).then(function(){t(e)}).catch(function(n){p.log(n),t(e)}):e.pushManager.getSubscription(p.scope).then(function(n){n?n.unsubscribe().then(function(){t(e)}).catch(function(){t(e)}):t(e)}).catch(function(n){t(e)})}),p.autoRegister&&$("html.default #defaultSubscribe").trigger("click")}"chrome"==p.platform&&e(),navigator.serviceWorker.register(p.defaultUrl+p.scope+"sw.js",{scope:p.scope}).then(function(e){p.log("[SW] Registration successful with scope: ",e.scope),r(e),p.log(e),t(e)}).catch(function(e){p.log("[SW] Registration failed",e)})}function c(){function e(e,t,n){return new Promise(function(o,r){var a,s;a=setTimeout(function(){a=!1,r({err:"Timed out on loading iframe"})},9e4);var c=new Promise(function(e,n){var o,i,r;r={},i=function(n){var a=n.origin||n.originalEvent.origin;if(a!=t)return void p.log("Origins doesn't match: "+a+" - "+t);"object"==typeof n.data&&(n.data.hasOwnProperty("permission")&&(p.log("[IC] <= Message from "+n.origin+": permission is "+n.data.permission+", timestamp is "+n.data.closedAt),r.permission=n.data.permission,r.closedAt=n.data.closedAt),n.data.hasOwnProperty("worker")&&(p.log("[IC] <= Message from "+n.origin+": token is "+n.data.worker),r.worker=n.data.worker)),r.iframeWindow=n.source,r.iframeObject=s,r.hasOwnProperty("permission")&&r.hasOwnProperty("worker")&&(window.removeEventListener("message",i,!1),o=!1===o||clearTimeout(o),e(r))},o=setTimeout(function(){o=!1,window.removeEventListener("message",i,!1),r.hasOwnProperty("permission")?e(r):n("Timed out on waiting message")},1e4),window.addEventListener("message",i,!1)});s=i(e,function(e){a=!1===a||clearTimeout(a),o(c)},function(e){a=!1===a||clearTimeout(a),r({err:"Fail to embed iframe",e:e})},n)})}function t(e,t,n){var o={},i=function(i){if((i.origin||i.originalEvent.origin)!=n)return void p.log("Origins doesn't match!!!");"object"==typeof i.data&&i.data.message&&i.data.serial&&i.data.result&&o.hasOwnProperty(i.data.serial)&&(p.log("[IC] <= Message from "+i.origin+": "+JSON.stringify(i.data)),o[i.data.serial](e,t,n,i.data.result),delete o[i.data.serial])};return window.addEventListener("message",i,!1),function(e,r,a){var s;return!1!==i&&("die"==e?(window.removeEventListener("message",i,!1),i=!1,!0):(s=d(),o[s]=r,a=a||{},a.message=e,a.serial=s,t.postMessage(a,n),!0))}}function o(e,t){return"#check-"+u(JSON.stringify([e,t]))}function i(e,t,n,o){var i=document.createElement("iframe");return i.setAttribute("frameborder","0"),i.setAttribute("scrolling","no"),i.setAttribute("sandbox","allow-same-origin allow-scripts allow-top-navigation allow-forms"),o?i.setAttribute("style","width: 100%; height: 0px; position: fixed; top: 0px; left: 0px; overflow: hidden;box-shadow: 0 10px 19px rgba(1, 8, 41, 0.07); z-index: 1000;"):i.setAttribute("style","width: 100%; height: 0px; position: fixed; bottom: 0px; left: 0px; overflow: hidden;box-shadow: 0 -10px 19px rgba(1, 8, 41, 0.07); z-index: 1000;"),i.addEventListener("load",t),i.addEventListener("error",n),i.src=e,document.body.appendChild(i),i}function r(){var e,t=$("#TUTBYPush-"+p.appId);t.length<1||(e=window.runCore&&window.runCore.get_option&&"bel"==window.runCore.get_option("lang")?"Налада апавяшчэнняў":"Настройка уведомлений","A"==t.get(0).tagName?t.attr("href","https://www.tut.by/push/?url="+encodeURIComponent(window.location.href.toString())).text(e):t.html('<a href="https://www.tut.by/push/?url='+encodeURIComponent(window.location.href.toString())+'">'+e+"</a>"))}var a,s,c=!!document.getElementsByTagName("HTML")[0].getAttribute("class").match(/\bsmart\b/);p.log("Start page workflow"),a=p.defaultUrl+p.scope+o(p.platform,window.location.origin),s=a.replace(/^(https:\/\/[^\/]+)\/.*$/,"$1"),p.dbh.get("closedAt").then(function(o){e(a,s,c).then(function(e){new n(p.dbh).manageToken(e.permission,e.worker).then(function(){var n,i=(new Date).valueOf();switch(e.permission){case"granted":e.iframeObject.remove(),r();break;case"default":if(o=e.closedAt?parseInt(e.closedAt,10):parseInt(o,10),isNaN(o)||i-o>864e5*p.notify_days_limit||"safari"==p.platform)n=t(e.iframeObject,e.iframeWindow,s,{}),n("close",function(e,t,n,r){function a(){e.remove()}try{window.yaCounter46086984.reachGoal("push_banner_close",function(){var e={};return e["push_"+p.platform]={closedAt:isNaN(o)?"never":Math.floor((i-o)/864e5)},e}())}catch(e){console.log(e)}p.dbh.put("closedAt",(new Date).valueOf()).then(a,a)}),n(c?"smartwelcome":"welcome",function(e,t,n,r){window.jQuery?$(e).animate({height:r+"px"},750):e.style.height=r+"px";try{window.yaCounter46086984.reachGoal("push_banner_show",function(){var e={};return e["push_"+p.platform]={visible:isNaN(o)?"never":Math.floor((i-o)/864e5)},e}())}catch(e){console.log(e)}},{url:window.location.toString()});else{e.iframeObject.remove();try{window.yaCounter46086984.reachGoal("push_banner_closed",function(){var e={};return e["push_"+p.platform]={invisible:isNaN(o)?"never":Math.floor((i-o)/864e5)},e}())}catch(e){console.log(e)}}r();break;case"denied":e.iframeObject.remove()}}).catch(function(t){p.log(t),e.iframeObject.remove()})}).catch(function(e){p.log("Iframe error",e)})}).catch(function(e){p.log(e)})}function u(e){return window.btoa(escape(encodeURIComponent(e)))}function l(e){return decodeURIComponent(unescape(window.atob(e)))}function d(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}function f(e,t){return new Promise(function(n,o){var i=new XMLHttpRequest;i.onreadystatechange=function(){4==i.readyState&&(200<=i.status&&i.status<=299?n(i):o(i))},i.open("POST",e,!0),i.setRequestHeader("Content-Type","application/json"),i.send(JSON.stringify(t))})}function h(e){return new Promise(function(t,n){var o=new MessageChannel;o.port1.onmessage=function(e){t(e.data)};try{navigator.serviceWorker.controller.postMessage(e,[o.port2])}catch(e){n(e)}})}e.prototype=function(){function e(e,t,n){e.onsuccess=function(e){t(e.target.result?e.target.result.value:void 0)},e.onerror=function(e){n(e)}}return{init:function(){var e=this;return new Promise(function(t,n){var o=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,i=o.open(e.name,e.version);i.onsuccess=function(e){t(e.target.result)},i.onerror=function(e){n(e)},i.onupgradeneeded=function(t){t.target.result.createObjectStore(e.table,{keyPath:"name"})}})},get:function(t){var n=this;return new Promise(function(o,i){n.init().then(function(i){o(new Promise(function(o,r){e(i.transaction([n.table],"readonly").objectStore(n.table).get(t),o,r)}))}).catch(function(e){i(e)})})},put:function(t,n){var o=this;return new Promise(function(i,r){o.init().then(function(r){i(new Promise(function(i,a){e(r.transaction([o.table],"readwrite").objectStore(o.table).put({name:t,value:n}),i,a)}))}).catch(function(e){r(e)})})},delete:function(t,n,o){var i=this;return new Promise(function(n,o){i.init().then(function(o){n(new Promise(function(n,r){e(o.transaction([i.table],"readwrite").objectStore(i.table).delete(t),n,r)}))}).catch(function(e){o(e)})})}}}(),t.prototype.init=function(t){function n(e){"interactive"===document.readyState||"complete"===document.readyState?e():document.addEventListener("DOMContentLoaded",e)}if(!window.runCore||!runCore.get_param("hide_push")){var o=i(window.location.hash);if(t=t||{},this.log(navigator.userAgent),this.debug=!!t.debug,this.autoRegister=!!t.autoRegister,this.platform=o?o[0]:r(o),this.targetOrigin=!!o&&o[1],this.appId=t.appId||"fe8daf4c-ea96-11e5-8de3-00215ae090fb",this.defaultUrl=t.defaultUrl||"https://www.tut.by"||window.location.origin,this.path=t.path||"/push/"||"/",this.scope=t.scope||this.path+this.appId+"/",this.gcm_sender_id=t.gcm_sender_id||"837219378249"||!1,this.apn_id=t.apn_id||"web.by.tut.push"||!1,this.notify_days_limit=parseInt(t.notify_days_limit,10)||90,this.return_url=t.return_url||!1,this.log("Push notifications platform: "+this.platform),this.https="https:"==window.location.protocol,this.subscribe_page=this.defaultUrl==window.location.origin&&0===window.location.pathname.indexOf(this.path)&&window.top===window,!this.platform)return this.subscribe_page&&(document.getElementsByTagName("html")[0].className="unsupported"),!1;if(!this.gcm_sender_id&&"chrome"==this.platform)return this.log("Push notifications platform is "+this.platform+" but GCM is not set"),!1;if(this.dbh=new e("TUTBYPush-"+this.appId,1),n(function(){var e,t=this;t.subscribe_page?(t.return_url||(e=window.location.search.match(/[?&]url=([^&#]+)/))&&e&&(e=decodeURIComponent(e[1]).match(/^(https?:\/\/.+)$/))&&e&&(t.return_url=e[1]),"safari"==t.platform?a():s()):window.top!==window&&t.targetOrigin?("safari"!=t.platform&&h({hash:o,scope:t.scope}).then(function(e){window.top.postMessage({worker:e},t.targetOrigin)}).catch(function(e){t.log(e)}),window.addEventListener("message",function(e){if(e.origin==o[1]&&"object"==typeof e.data&&e.data.hasOwnProperty("message")&&e.data.hasOwnProperty("serial"))switch(t.log("[IC] => Message from "+e.origin+": "+JSON.stringify(e.data)),e.data.message){case"smartwelcome":case"welcome":$("html").attr("class",e.data.message),e.data&&e.data.url&&(t.return_url=e.data.url,$("#welcomeLink,#smartwelcomeClose").attr("href","https://www.tut.by/push/?url="+encodeURIComponent(t.return_url)),$('input[name="url"]').val(t.return_url)),e.source.postMessage({message:e.data.message,serial:e.data.serial,result:window.document.body.clientHeight},e.origin);break;case"close":$("#welcomeClose,#smartwelcomeClose").on("click",function(n){n.preventDefault();try{t.dbh.put("closedAt",(new Date).valueOf()).then(function(){e.source.postMessage({message:e.data.message,serial:e.data.serial,result:!0},e.origin)},function(){})}catch(n){t.log(n),e.source.postMessage({message:e.data.message,serial:e.data.serial,result:!0},e.origin)}return!1})}},!1)):c()}.bind(this)),window.top!==window&&this.targetOrigin)try{p.dbh.get("closedAt").then(function(e){window.top.postMessage({permission:Notification.permission,closedAt:e},this.targetOrigin)}.bind(this))}catch(e){p.log(e),window.top.postMessage({permission:Notification.permission},this.targetOrigin)}return!0}},t.prototype.log=function(e){this.debug&&console&&console.log&&(console.group(window.location.origin),console.log.apply(console,arguments),console.groupEnd())},n.prototype.getToken=function(){return new Promise(function(e,t){p.dbh.get("token").then(e).catch(t)})},n.prototype.setToken=function(e){return new Promise(function(t,n){p.dbh.put("token",e).then(t).catch(n)})},n.prototype.removeToken=function(){return new Promise(function(e,t){p.dbh.delete("token").then(e).catch(t)})},n.prototype.endPoint=function(e){return p.defaultUrl+p.scope+e},n.prototype.data=function(e){return{platform:p.platform,token:e}},n.prototype.manageToken=function(e,t){var n=this;return t={token:t,tm:(new Date).valueOf()},new Promise(function(o,i){n.getToken().then(function(r){if(r&&r.token)switch(e){case"granted":t.token?t.token==r.token?t.tm-r.tm>2592e6?f(n.endPoint("subscribe"),n.data(t.token)).then(function(e){n.setToken(t).then(o).catch(i)}).catch(i):o():f(n.endPoint("subscribe"),n.data([t.token,r.token])).then(function(e){n.setToken(t).then(o).catch(i)}).catch(i):f(n.endPoint("unsubscribe"),n.data(r.token)).then(function(e){n.removeToken().then(o).catch(i)}).catch(i);break;case"default":case"denied":default:f(n.endPoint("unsubscribe"),n.data(r.token)).then(function(e){n.removeToken().then(o).catch(i)}).catch(i)}else if(t.token)switch(e){case"granted":f(n.endPoint("subscribe"),n.data(t.token)).then(function(e){n.setToken(t).then(o).catch(i)}).catch(i);break;case"default":case"denied":default:o()}else o()}).catch(i)})};var p=new t;return p}();